function Player(){var timer,overtime,Myself=this;function windowAudioContext(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;try{Myself.audioContext=new AudioContext}catch(e){console.log("您的浏览器不支持 AudioContext,信息:"+e)}}function createParts(){var audio=document.createElement("AUDIO"),player;audio.crossOrigin="anonymous",document.getElementById("player").appendChild(audio),Myself.audio=audio;var control=document.getElementById("playerControl"),button=Myself.button;if(button.prev){var prevBtn=document.createElement("i"),playPrev;prevBtn.className="icon-previous",prevBtn.id="playPrev",prevBtn.title="上一首",prevBtn.innerHTML="&#xea23;",control.appendChild(prevBtn),document.getElementById("playPrev").onclick=function(){prev()}}if(button.play){var playBtn=document.createElement("i"),playControl;playBtn.className="icon-play",playBtn.id="playControl",playBtn.title="播放",playBtn.innerHTML="&#xea1c;",playBtn.setAttribute("data","pause"),control.appendChild(playBtn),document.getElementById("playControl").onclick=function(){play()}}if(button.next){var nextBtn=document.createElement("i"),playNext;nextBtn.className="icon-next",nextBtn.id="playNext",nextBtn.title="下一首",nextBtn.innerHTML="&#xea24;",control.appendChild(nextBtn),document.getElementById("playNext").onclick=function(){next()}}if(button.volume){var volumeBox=document.createElement("div"),volumeBtn;volumeBox.id="volumeBox",control.appendChild(volumeBox),(volumeBtn=document.createElement("i")).className="icon-volume",volumeBtn.id="playVolume",volumeBtn.title="音量",playBtn&&playBtn.setAttribute("data","normal"),volumeBtn.innerHTML="&#xea27;",volumeBox.appendChild(volumeBtn);var volumeBar=document.createElement("div");volumeBar.id="volumeBar",volumeBox.appendChild(volumeBar);var volumeSize=document.createElement("div"),volumeBtn;volumeSize.id="volumeSize",volumeBar.appendChild(volumeSize),volumeBar.onclick=function(event){volumeChange(event,volumeBar,volumeSize)},(volumeBtn=document.getElementById("playVolume")).onclick=function(){volume()}}var playerTime=document.getElementById("playerTime");if(playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%",Myself.playerTime=playerTime,Myself.button.progressControl){var progress=document.getElementById("progress");progress.style.cursor="pointer",progress.onclick=function(event){progressControl(event,progress)}}windowAudioContext();var playList=Myself.playList;Myself.audio.src=playList[0].mp3;var songInfo=document.getElementById("songInfo"),songTitle=document.createElement("div");songTitle.id="songTitle",songInfo.appendChild(songTitle);var album=document.createElement("div");album.id="album",songInfo.appendChild(album);var span=document.createElement("span");span.innerHTML="-",songInfo.appendChild(span);var artist=document.createElement("div");artist.id="artist",songInfo.appendChild(artist),Myself.nowPlay=0,updates(),Myself.audio.volume=volumeGetCookie(),Myself.autoPlay&&play()}function play(autoPlay=!1){var playBtn=document.getElementById("playControl");Myself.audio.paused?(Myself.audio.play(),playBtn&&(playBtn.setAttribute("data","play"),playBtn.title="暂停",playBtn.innerHTML="&#xea1d;"),timer=setInterval((function(){showTime(),playerState()}),1e3),updates(),0==Myself.handle&&playHandle()):(Myself.audio.pause(),playBtn&&(playBtn.setAttribute("data","pause"),playBtn.title="播放",playBtn.innerHTML="&#xea1c;"),window.clearInterval(timer)),Myself.event({eventType:"play",describe:"播放/暂停"})}function updates(){var List=Myself.playList,nowPlay=Myself.nowPlay,songTitle=document.getElementById("songTitle");songTitle.innerHTML=List[nowPlay].title,songTitle.title="歌曲:"+List[nowPlay].title;var songAlbum=document.getElementById("album");songAlbum.innerHTML="("+List[nowPlay].album+")",songAlbum.title="所属专辑:"+List[nowPlay].album;var songArtist=document.getElementById("artist");songArtist.innerHTML=List[nowPlay].artist,songArtist.title="艺术家:"+List[nowPlay].artist}function playerState(){var state=Myself.audio.readyState,playerState=document.getElementById("playerState"),songInfo=document.getElementById("songInfo");4==state?null!=playerState&&(songInfo.removeChild(playerState),window.clearTimeout(overtime)):null==playerState&&((playerState=document.createElement("div")).id="playerState",playerState.innerHTML="<i class='icon-music'>&#xe911;</i>加载中……",songInfo.appendChild(playerState),overtime=setTimeout((function(){0==Myself.audio.readyState&&(playerState.innerHTML="加载失败!")}),12e4))}function showTime(){if(4==Myself.audio.readyState){var duration=Myself.audio.duration,currentTime=Myself.audio.currentTime,surplusTime=duration-currentTime,ratio=(currentTime/duration*100).toFixed(1);function timeFormat(t){return Math.floor(t/60)+":"+(t%60/100).toFixed(2).slice(-2)}ratio=100==ratio?100:ratio,Myself.playerTime.innerHTML="-&nbsp;"+timeFormat(surplusTime)+"&nbsp;/&nbsp;"+timeFormat(duration)+"&nbsp;&nbsp;&nbsp;&nbsp;"+ratio+"%",document.getElementById("playerProgressBar").style.width=ratio+"%",100==ratio&&next()}else Myself.playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%"}function prev(){0==Myself.nowPlay&&(Myself.nowPlay=Myself.playList.length),Myself.nowPlay=Myself.nowPlay-1,Myself.audio.src=Myself.playList[Myself.nowPlay].mp3,window.clearInterval(timer),null!=Myself.analyser&&drawSpectrum(Myself.analyser),Myself.event({eventType:"prev",describe:"播放上一首"}),play()}function next(){Myself.nowPlay==Myself.playList.length-1&&(Myself.nowPlay=-1),Myself.nowPlay=Myself.nowPlay+1,Myself.audio.src=Myself.playList[Myself.nowPlay].mp3,window.clearInterval(timer),null!=Myself.analyser&&drawSpectrum(Myself.analyser),Myself.event({eventType:"next",describe:"播放上一首"}),play()}function volume(){if(Myself.button.volume){var volumeBtn=document.getElementById("playVolume"),data;"normal"==volumeBtn.getAttribute("data")?(volumeBtn.setAttribute("data","mute"),volumeBtn.innerHTML="&#xea27;"):(volumeBtn.setAttribute("data","normal"),volumeBtn.innerHTML="&#xea2a;")}Myself.audio.muted?Myself.audio.muted=!1:Myself.audio.muted=!0}function volumeChange(e,volumeBar,volumeSize){var offsetX,width,proportion=e.offsetX/volumeBar.offsetWidth;volumeSize.style.width=100*proportion+"%";var size=proportion;Myself.audio.volume=size,volumeSetCookie(size)}function volumeSetCookie(size){var d=new Date;d.setHours(d.getHours()+720),document.cookie="playerVolume="+size+";expires="+d.toGMTString()}function volumeGetCookie(){var volumeSize=document.getElementById("volumeSize"),arr,reg=new RegExp("(^| )playerVolume=([^;]*)(;|$)"),volume=1;return volume=(arr=document.cookie.match(reg))?unescape(arr[2]):.5,volumeSize.style.width=100*volume+"%",volume}function progressControl(e,progress){var offsetX,width,proportion=e.offsetX/progress.offsetWidth,duration,playTime=Myself.audio.duration*proportion;Myself.audio.currentTime=playTime}function playHandle(){windowAudioContext();var audioContext=Myself.audioContext,analyser=audioContext.createAnalyser(),playData;audioContext.createMediaElementSource(Myself.audio).connect(analyser),analyser.connect(audioContext.destination),drawSpectrum(analyser),Myself.analyser=analyser,Myself.handle=1}function drawSpectrum(analyser){var colorArray=["#f82466","#00FFFF","#AFFF7C","#FFAA6A","#6AD5FF","#D26AFF","#FF6AE6","#FF6AB8","#FF6A6A","#7091FF"],colorRandom=Math.floor(Math.random()*colorArray.length);Myself.color=colorArray[colorRandom];var effectRandom=Math.floor(2*Math.random());switch(-1!=Myself.effect&&(effectRandom=Myself.effect),effectRandom){case 0:bar(analyser);break;case 1:circular(analyser);break;default:bar(analyser)}}function colorRgb(color,opacity){var reg;if(opacity=(opacity=opacity<0?0:opacity)>1?1:opacity,color&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(color)){if(4===color.length){for(var sColorNew="#",i=1;i<4;i+=1)sColorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));color=sColorNew}for(var sColorChange=[],i=1;i<7;i+=2)sColorChange.push(parseInt("0x"+color.slice(i,i+2)));return"rgba("+sColorChange.join(",")+","+opacity+")"}return color}function bar(analyser){var canvas=document.getElementById(Myself.canvasId),cwidth=canvas.width,cheight=canvas.height-2,meterWidth=10,capHeight=2,capStyle="#FFFFFF",meterNum=1e3/12,ctx=canvas.getContext("2d"),capYPositionArray=[],gradient=ctx.createLinearGradient(0,0,0,300);gradient.addColorStop(1,Myself.color);var drawMeter=function(){var array=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(array);var step=Math.round(array.length/(1e3/12));ctx.clearRect(0,0,cwidth,cheight);for(var i=0;i<1e3/12;i++){var value=array[i*step];Myself.event({eventType:"energy",describe:value}),capYPositionArray.length<Math.round(1e3/12)&&capYPositionArray.push(value),ctx.fillStyle=capStyle,value<capYPositionArray[i]?ctx.fillRect(12*i,cheight- --capYPositionArray[i],10,2):(ctx.fillRect(12*i,cheight-value,10,2),capYPositionArray[i]=value),ctx.fillStyle=gradient,ctx.fillRect(12*i,cheight-value+2,10,cheight)}requestAnimationFrame(drawMeter)};requestAnimationFrame(drawMeter)}function circular(analyser){var canvas=document.getElementById(Myself.canvasId),width=canvas.width,height=canvas.height,ctx=canvas.getContext("2d"),draw=function(){var array=new Uint8Array(128);analyser.getByteFrequencyData(array),ctx.clearRect(0,0,width,height);for(var i=0;i<array.length;i++){var value=array[i];ctx.beginPath(),ctx.arc(width/2,height/2,.8*value,0,400,!1),ctx.lineWidth=2,ctx.strokeStyle=colorRgb(Myself.color,value/1e3),ctx.stroke(),ctx.closePath(),Myself.event({eventType:"energy",describe:value})}requestAnimationFrame(draw)};requestAnimationFrame(draw)}Myself.button={prev:!0,play:!0,next:!0,volume:!0,progressControl:!0},Myself.analyser=null,Myself.event=function(e){},this.config=function(Object){Myself.playList=Object.playList,Myself.canvasId=Object.canvasId,Myself.autoPlay=Object.autoPlay,Myself.event=null==Object.event?Myself.event:Object.event,Myself.button=null==Object.button?Myself.button:Object.button,Myself.effect=null==Object.effect?-1:Object.effect,Myself.handle=0,createParts()}}